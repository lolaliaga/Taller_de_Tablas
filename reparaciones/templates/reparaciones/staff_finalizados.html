{% extends "reparaciones/base.html" %}

{% block title %}Finalizados{% endblock %}

{% block content %}
<section class="dashboard-shell">
    <h1 class="page-title">Finalizados</h1>

    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Reparación</th>
                    <th>Cliente</th>
                    <th>Último presupuesto</th>
                    <th>Factura final</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for reparacion in reparaciones %}
                    {% with ultimo_presupuesto=reparacion.presupuestos_ordenados|first %}
                        <tr>
                            <td>#{{ reparacion.id }} · {{ reparacion.tipo_equipo }}</td>
                            <td>{{ reparacion.nombre_cliente }}</td>
                            <td>
                                {% if ultimo_presupuesto %}
                                    {{ ultimo_presupuesto.get_estado_display }}
                                    {% if ultimo_presupuesto.monto %}
                                        · {{ ultimo_presupuesto.moneda }} {{ ultimo_presupuesto.monto }}
                                    {% endif %}
                                    · #{{ ultimo_presupuesto.id }}
                                {% else %}
                                    Sin presupuesto
                                {% endif %}
                            </td>
                            <td>
                                {% if reparacion.factura_final_safe %}
                                    {% if reparacion.factura_final_safe.monto_total %}
                                        {{ reparacion.factura_final_safe.moneda }} {{ reparacion.factura_final_safe.monto_total }}
                                    {% else %}
                                        Factura cargada
                                    {% endif %}
                                    · <a href="{% url 'descargar_factura_final' reparacion.id %}">Ver / Descargar</a>
                                {% else %}
                                    Sin factura · <a href="{% url 'staff_factura_final' reparacion.id %}">Cargar factura</a>
                                {% endif %}
                            </td>
                            <td>
                                <div class="table-actions">
                                    {% if not reparacion.factura_final_safe %}
                                        <a class="nav-button" href="{% url 'staff_factura_final' reparacion.id %}">Cargar factura</a>
                                    {% else %}
                                        <a class="nav-button" href="{% url 'descargar_factura_final' reparacion.id %}">Descargar factura</a>
                                    {% endif %}
                                    {% if request.user.is_superuser %}
                                        <form method="post" action="{% url 'staff_reabrir_reparacion' reparacion.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="nav-button">Reabrir</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endwith %}
                {% empty %}
                    <tr>
                        <td colspan="5" class="table-empty">No hay reparaciones finalizadas.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
